(function(){console.log("[Auto-Flow Content] Script loaded");chrome.runtime.onMessage.addListener((e,n,t)=>{if(console.log("[Auto-Flow Content] Received message:",e),e.type==="EXECUTE_WORKFLOW")return m(e.steps).then(()=>{console.log("[Auto-Flow Content] Workflow completed successfully"),t({success:!0})}).catch(o=>{console.error("[Auto-Flow Content] Workflow failed:",o),t({success:!1,error:o.message})}),!0});async function m(e){for(let n=0;n<e.length;n++){const t=e[n];console.log(`[Auto-Flow Content] Executing step ${n+1}/${e.length}:`,t);try{await g(t),await s(300)}catch(o){throw new Error(`Step ${n+1} failed: ${o instanceof Error?o.message:"Unknown error"}`)}}}async function g(e){switch(e.type){case"fillInput":await E(e.selector,e.value);break;case"click":await f(e.selector,e.index);break;case"wait":e.selector?await h(e.selector):e.duration&&await s(e.duration);break;case"waitForNewResults":await b(e.selector,e.expectedCount);break;case"download":await f(e.selector,e.index);break;default:throw new Error(`Unknown step type: ${e.type}`)}}async function E(e,n){const t=document.querySelector(e);if(!t)throw new Error(`Element not found: ${e}`);if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[Auto-Flow Content] Filled input ${e} with: ${n}`);else if(t instanceof HTMLElement){t.focus();const o=t.closest('[contenteditable="true"]')!==null;if(t.hasAttribute("data-lexical-text")||t.querySelector("[data-lexical-text]")!==null||o||t.isContentEditable||t.hasAttribute("contenteditable")){let l=t;if(!t.isContentEditable&&!t.hasAttribute("contenteditable")){const i=t.closest('[contenteditable="true"]');i instanceof HTMLElement&&(l=i,l.focus())}const a=window.getSelection(),r=document.createRange();if(r.selectNodeContents(l),a?.removeAllRanges(),a?.addRange(r),document.execCommand("delete",!1),await s(100),!document.execCommand("insertText",!1,n)){console.log("[Auto-Flow Content] execCommand failed, trying clipboard method");const i=new DataTransfer;i.setData("text/plain",n);const d=new ClipboardEvent("paste",{bubbles:!0,cancelable:!0,clipboardData:i});if(l.dispatchEvent(d),d.defaultPrevented){console.log("[Auto-Flow Content] Paste prevented, using manual insertion"),l.focus();const c=document.createRange();c.selectNodeContents(l),c.collapse(!1),a?.removeAllRanges(),a?.addRange(c);const w=document.createTextNode(n);c.insertNode(w),c.setStartAfter(w),c.collapse(!0),a?.removeAllRanges(),a?.addRange(c),l.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!1,inputType:"insertText",data:n}))}}l.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[Auto-Flow Content] Filled contentEditable/Lexical ${e} with: ${n}`)}else t.textContent=n,t.dispatchEvent(new Event("input",{bubbles:!0})),console.log(`[Auto-Flow Content] Set text content of ${e} to: ${n}`)}else throw new Error(`Element ${e} is not a valid input element`)}async function f(e,n){if(n!==void 0){const t=document.querySelectorAll(e);if(t.length===0)throw new Error(`No elements found: ${e}`);if(n>=t.length)throw new Error(`Index ${n} out of range. Found ${t.length} elements for: ${e}`);t[n].click(),console.log(`[Auto-Flow Content] Clicked element [${n}]: ${e}`)}else{const t=document.querySelector(e);if(!t)throw new Error(`Element not found: ${e}`);t.click(),console.log(`[Auto-Flow Content] Clicked element: ${e}`)}}async function h(e,n=1e4){const t=Date.now();for(;Date.now()-t<n;){if(document.querySelector(e)){console.log(`[Auto-Flow Content] Element found: ${e}`);return}await s(100)}throw new Error(`Element not found within ${n}ms: ${e}`)}async function b(e,n,t=6e4){const o=document.querySelectorAll(e).length,u=o+n,l=Date.now();for(console.log(`[Auto-Flow Content] Waiting for ${n} new results. Initial count: ${o}, Target: ${u}`);Date.now()-l<t;){const r=document.querySelectorAll(e).length;if(r>=u){console.log(`[Auto-Flow Content] New results appeared! Count: ${r}`);return}await s(500)}const a=document.querySelectorAll(e).length;throw new Error(`Expected ${n} new results within ${t}ms. Initial: ${o}, Final: ${a}`)}function s(e){return new Promise(n=>setTimeout(n,e))}
})()